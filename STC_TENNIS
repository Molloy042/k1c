# Install required packages before running:
# pip install playwright

from playwright.sync_api import sync_playwright
import time
from datetime import date, timedelta, datetime
import random 

# --- é…ç½®ä¿¡æ¯ ---
URL = "https://members.swtc.ca/login.html"
BOOKING_URL = "https://members.swtc.ca/booking.html" # æ–°å¢é¢„å®šé¡µé¢URL
USERNAME_XPATH = '//*[@id="login-form-username"]'
PASSWORD_XPATH = '//*[@id="login-form-password"]'
USER = 'Ssherryyan'
PASSWORD = 'Ysq.970317'

# =======================================================
#                  â­ æµ‹è¯•æ¨¡å¼å¼€å…³
# =======================================================
TEST_MODE = True
# =======================================================

TARGET_HOUR = 8
TARGET_MINUTE = 15
TEST_DELAY_SECONDS = 15 

MAX_BOOKED_COUNT = 2 

# =======================================================
#               ğŸ¾ é¢„å®šæ—¶é—´æ®µå’Œåœºåœ°ä¼˜å…ˆçº§é…ç½®
# =======================================================
DEFAULT_COURT_PRIORITIES = [
    [6, 7, 8, 9, 10],  # ä¼˜å…ˆçº§ 1: åœºåœ° 6 åˆ° 10 (éšæœºé€‰æ‹©)
    [1, 2, 3, 4]       # ä¼˜å…ˆçº§ 2: åœºåœ° 1 åˆ° 4 (éšæœºé€‰æ‹©)
]

PREFERRED_GROUPS = [
    (8, 9),    # 8:00 - 9:00
    (9, 10),   # 9:00 - 10:00
]
# =======================================================

def ensure_correct_date_view(page, target_date_booking, date_str):
    """
    å¯¼èˆªåˆ°é¢„å®šé¡µé¢ï¼Œæ‰§è¡Œè·¨æœˆæ£€æŸ¥å’Œæ—¥æœŸç‚¹å‡»æ“ä½œã€‚
    è¿”å› True è¡¨ç¤ºæˆåŠŸï¼ŒFalse è¡¨ç¤ºå¤±è´¥ã€‚
    """
    print(f"\n--- é‡æ–°åŠ è½½é¡µé¢å¹¶ç¡®ä¿æ—¥æœŸè§†å›¾ ({date_str}) ---")
    
    # 1. é‡æ–°å®šå‘åˆ°é¢„å®šé¡µé¢
    try:
        page.goto(BOOKING_URL)
        page.wait_for_load_state('networkidle', timeout=5000)
        time.sleep(0.5) # ç¡®ä¿æ—¥å†åŠ è½½
    except Exception as e:
        print(f"âŒ æ— æ³•åŠ è½½é¢„å®šé¡µé¢ {BOOKING_URL}ï¼ŒæŠ¢åœºæµç¨‹ç»ˆæ­¢ã€‚")
        return False

    # 2. è·¨æœˆæ£€æŸ¥å’Œç‚¹å‡»
    today_date_only = date.today()
    
    if target_date_booking.year > today_date_only.year or (target_date_booking.year == today_date_only.year and target_date_booking.month > today_date_only.month):
        print("ğŸŒ ç›®æ ‡æ—¥æœŸåœ¨ä¸‹ä¸€ä¸ªæœˆä»½ã€‚éœ€è¦ç‚¹å‡»'ä¸‹ä¸€ä¸ªæœˆ'æŒ‰é’®ã€‚")
        next_month_xpath = '//*[@id="calendar"]/div[1]/div[3]/i'
        try:
            page.locator(next_month_xpath).wait_for(timeout=200)
            page.locator(next_month_xpath).click()
            time.sleep(0.5) 
            print("âœ… æˆåŠŸç‚¹å‡»'ä¸‹ä¸€ä¸ªæœˆ'ã€‚")
        except Exception:
            print(f"âŒ æ— æ³•ç‚¹å‡»'ä¸‹ä¸€ä¸ªæœˆ'æŒ‰é’®ï¼Œç»ˆæ­¢æŠ¢åœºã€‚")
            return False
    else:
        print("ğŸ“… ç›®æ ‡æ—¥æœŸåœ¨å½“å‰æœˆä»½ã€‚æ— éœ€ç‚¹å‡»'ä¸‹ä¸€ä¸ªæœˆ'ã€‚")

    # 3. ç‚¹å‡»æ—¥æœŸæŒ‰é’®
    date_button_xpath = f'//button[@data-value="{date_str}"]'
    print(f"å°è¯•ç‚¹å‡» {date_str} çš„æ—¥æœŸæŒ‰é’®...")

    MAX_RETRIES = 50 
    DATE_CLICKED = False
    
    for attempt in range(1, MAX_RETRIES + 1):
        try:
            page.locator(date_button_xpath).wait_for(timeout=50) 
            page.locator(date_button_xpath).click()
            
            print(f"âœ… æˆåŠŸç‚¹å‡»æ—¥æœŸæŒ‰é’®: {date_str}")
            DATE_CLICKED = True
            break
        
        except Exception:
            if attempt == MAX_RETRIES:
                print(f"âŒ å°è¯• {MAX_RETRIES} æ¬¡åï¼Œä»æ— æ³•ç‚¹å‡»æ—¥æœŸæŒ‰é’® {date_str}ã€‚æŠ¢åœºç»ˆæ­¢ã€‚")
                return False
    
    return DATE_CLICKED


def run_booking_script():
    """æ‰§è¡Œ Playwright è‡ªåŠ¨åŒ–é¢„å®šæµç¨‹"""
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False) 
        context = browser.new_context()
        page = context.new_page()

        # 1. æ‰“å¼€é¡µé¢å¹¶ç™»å½•
        page.goto(URL)
        time.sleep(1) 
        
        print("å¼€å§‹ç™»å½•...")
        page.locator(f"xpath={USERNAME_XPATH}").fill(USER)
        page.locator(f"xpath={PASSWORD_XPATH}").fill(PASSWORD)
        
        # 2. äººå·¥ä»‹å…¥ç‚¹ - å¤„ç†ç™»å½•/éªŒè¯ç 
        input("è¯·å®Œæˆäººå·¥æ“ä½œï¼ˆç™»å½•/éªŒè¯ç /äºŒæ¬¡ç¡®è®¤ç­‰ï¼‰ï¼Œå®ŒæˆåæŒ‰å›è½¦ç»§ç»­...")
        time.sleep(1)

        # =======================================================
        #                   ğŸ“… å¯åŠ¨æ—¶çš„æ—¥æœŸè®¡ç®—
        # =======================================================
        today = date.today()
        
        if TEST_MODE:
            days_after = 3  
        else:
            days_after = 6  
        
        target_date_booking = today + timedelta(days=days_after) 
        date_str = target_date_booking.strftime("%Y-%m-%d")
        #date_str = '2025-12-16'  # ä¸´æ—¶ç¡¬ç¼–ç æµ‹è¯•ç”¨
        # =======================================================
        #                   ğŸš€ æ ¸å¿ƒé«˜ç²¾åº¦å®šæ—¶æŠ¢åœºé€»è¾‘
        # =======================================================
        current_datetime = datetime.now()
        
        if TEST_MODE:
            target_time = current_datetime + timedelta(seconds=TEST_DELAY_SECONDS)
        else:
            target_time = current_datetime.replace(hour=TARGET_HOUR, minute=TARGET_MINUTE, second=0, microsecond=0)

            # ğŸš¨ æ£€æŸ¥æ˜¯å¦å·²é”™è¿‡ä»Šå¤©çš„æŠ¢ç¥¨æ—¶é—´
            if target_time < current_datetime - timedelta(seconds=600):
                target_time += timedelta(days=1)
                target_date_booking += timedelta(days=1) 
                date_str = target_date_booking.strftime("%Y-%m-%d")
                print(f"ğŸš¨ ä»Šå¤©çš„æŠ¢åœºæ—¶é—´å·²è¿‡ã€‚ç›®æ ‡æ—¶é—´è°ƒæ•´ä¸ºæ˜å¤©: {target_time.strftime('%H:%M:%S.%f')}ï¼Œé¢„å®šæ—¥æœŸä¹ŸåŒæ­¥è°ƒæ•´ä¸º {date_str} (7å¤©å)")

        wait_seconds = (target_time - current_datetime).total_seconds()
        
        if wait_seconds > 0:
            # æ‰§è¡Œç­‰å¾…... (ä¿æŒé«˜ç²¾åº¦ç­‰å¾…ä»£ç )
            COARSE_WAIT_THRESHOLD = 5.0 
            if wait_seconds > COARSE_WAIT_THRESHOLD:
                coarse_sleep_time = wait_seconds - 1.0 
                time.sleep(coarse_sleep_time)
                wait_seconds = (target_time - datetime.now()).total_seconds()
                print(f"â³ å‰©ä½™ç­‰å¾…æ—¶é—´çº¦ {wait_seconds:.3f} ç§’ã€‚")

            start_counter = time.perf_counter() 
            print("âš¡ï¸ è¿›å…¥é«˜ç²¾åº¦ç­‰å¾…çŠ¶æ€ (Spin Lock)...")
            while (time.perf_counter() - start_counter) < wait_seconds:
                pass 
                
            print("ğŸ”” åˆ°è¾¾é¢„å®šæ—¶é—´ï¼Œå¼€å§‹æ‰§è¡ŒæŠ¢åœºï¼")
        else:
            print("âš ï¸ ç›®æ ‡æ—¶é—´å·²è¿‡ï¼Œç«‹å³æ‰§è¡ŒæŠ¢åœºã€‚")
            
        # =======================================================
        #                   ğŸ¾ é¢„å®šåœºåœ°é€»è¾‘ - æ­¥éª¤ 1: ç¡®ä¿æ—¥æœŸè§†å›¾æ­£ç¡®
        # =======================================================

        if not ensure_correct_date_view(page, target_date_booking, date_str):
            print("âŒ æ— æ³•åœ¨æŠ¢åœºå…³é”®æ—¶åˆ»ç¡®ä¿æ—¥æœŸè§†å›¾æ­£ç¡®ã€‚æŠ¢åœºæµç¨‹ç»ˆæ­¢ã€‚")
            return 

        # =======================================================
        #                   ğŸ¾ é¢„å®šåœºåœ°é€»è¾‘ - æ­¥éª¤ 2: éå†æ—¶é—´æ®µå’Œä¼˜å…ˆçº§ç»„
        # =======================================================
        time.sleep(0.1) 

        booked_count = 0
        
        # éå†æ¯ä¸€ä¸ª PREFERRED_GROUPS ä¸­å®šä¹‰çš„æ—¶é—´æ®µ
        for start_h, end_h in PREFERRED_GROUPS:
            if booked_count >= MAX_BOOKED_COUNT:
                print(f"å·²è¾¾åˆ°æœ€å¤§é¢„å®šæ•°é‡ {MAX_BOOKED_COUNT}ï¼Œåœæ­¢é¢„å®šã€‚")
                break
            
            slot_booked_in_time = False 
            
            start_time_str = f"{start_h}00"
            end_time_str = f"{end_h}00"
            time_slot_label = f"{start_h}:00-{end_h}:00"
            print(f"\n--- å¼€å§‹å¤„ç†æ—¶é—´æ®µ: {time_slot_label} ---")
            
            # éå† DEFAULT_COURT_PRIORITIES ä¼˜å…ˆçº§ç»„
            for group_index, court_list in enumerate(DEFAULT_COURT_PRIORITIES):
                if slot_booked_in_time:
                    break 
                
                courts_to_try = court_list[:] 
                random.shuffle(courts_to_try) 
                
                print(f"  - å°è¯•ä¼˜å…ˆçº§ç»„ {group_index + 1} (åœºåœ°éšæœºé¡ºåº: {courts_to_try})")
                
                # éå†ç»„å†…æ‰€æœ‰åœºåœ°
                for court_id in courts_to_try:
                    slot_data_value = f"{start_time_str}|{end_time_str}|{court_id}"
                    slot_xpath = f'//button[@data-value="{slot_data_value}" and contains(@class, "available")]'
                    
                    try:
                        # å°è¯•ç­‰å¾…å¯ç”¨æŒ‰é’®å¹¶ç‚¹å‡»
                        available_locator = page.locator(slot_xpath)
                        available_locator.wait_for(timeout=100) 
                        
                        print(f"    -> å‘ç°å¹¶ç‚¹å‡»å¯ç”¨åœºåœ°: åœºåœ° {court_id}")
                        available_locator.click()
                        time.sleep(0.1) 
                        
                        # *** æœ€ç»ˆç¡®è®¤ç‚¹å‡»é€»è¾‘ (ä¸¤æ¬¡ç‚¹å‡») ***
                        confirm_button_1_xpath = '//*[@id="book-button"]/div/a'
                        page.locator(confirm_button_1_xpath).click() 
                        time.sleep(0.1) 

                        confirm_button_2_xpath = '//*[@id="cd-popup"]/div/ul/li[1]/a'
                        page.locator(confirm_button_2_xpath).click() 
                        time.sleep(0.1)

                        print(f"ğŸ† æˆåŠŸé¢„å®š: {time_slot_label}, åœºåœ° {court_id}ã€‚")
                        booked_count += 1
                        slot_booked_in_time = True 
                        
                        # â­ NEW: é¢„å®šæˆåŠŸåï¼Œé‡æ–°åŠ è½½é¡µé¢å¹¶ç¡®ä¿æ—¥æœŸè§†å›¾
                        if booked_count < MAX_BOOKED_COUNT: # åªæœ‰å½“è¿˜éœ€è¦é¢„å®šæ›´å¤šåœºåœ°æ—¶æ‰é‡è½½
                             if not ensure_correct_date_view(page, target_date_booking, date_str):
                                 print("âŒ é‡æ–°åŠ è½½é¡µé¢æˆ–æ—¥æœŸé‡é€‰å¤±è´¥ï¼Œä¸­æ–­åç»­é¢„å®šã€‚")
                                 return

                        break # è·³å‡ºåœºåœ°å¾ªç¯
                        
                    except Exception:
                        # åœºåœ°ä¸å¯ç”¨æˆ–ç¡®è®¤å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªåœºåœ°
                        continue 

        print("\n--- æ‰€æœ‰åœºåœ°å°è¯•å®Œæ¯• ---")

if __name__ == '__main__':
    run_booking_script()
